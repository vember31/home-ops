apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: sonarr-quality-definitions
  namespace: downloads
spec:
  schedule: "0 1 * * *"  # Run daily at 1am
  timeZone: ${TIMEZONE}
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: sonarr-curl
            image: curlimages/curl:8.6.0@sha256:6be0eb01bbdc8963a3dfe6e3f33b52c2c8ddefec347c328913f5104e28465b6f
            command:
            - "sh"
            - "-c"
            - |
              SONARR_URL="http://sonarr.downloads.svc.cluster.local:8989"  # Replace with your Sonarr URL
              API_KEY="${SONARR__API_KEY}"  # Replace with your Sonarr API key
              QUALITY_DEFINITIONS=(                   # ID:PREFERRED_SIZE:MAX_SIZE
                "7:17.4:25.4"                         # HDTV-720p @ 1Gb/hr preferred, 1.5Gb/hr max
                "10:17.4:25.4"                        # WEBRip-720p @ 1Gb/hr preferred, 1.5Gb/hr max
                "11:17.4:25.4"                        # WEBDL-720p @ 1Gb/hr preferred, 1.5Gb/hr max
                "8:23:50.4"                           # HDTV-1080p @ 1.3Gb/hr preferred, 3Gb/hr max
                "13:23:50.4"                          # WEBRip-1080p @ 1.3Gb/hr preferred, 3Gb/hr max
                "14:23:50.4"                          # WEBDL-1080p @ 1.3Gb/hr preferred, 3Gb/hr max
                "15:23:50.4"                          # Bluray-1080p @ 1.3Gb/hr preferred, 3Gb/hr max
                "16:23:50.4"                          # Bluray-1080p Remux @ 1.3Gb/hr preferred, 3Gb/hr max        
              )
              for DEF in "$${QUALITY_DEFINITIONS[@]}"; do
                IFS=':' read -r DEF_ID DEF_MAX_SIZE DEF_PREFERRED_SIZE <<< "$$DEF"
                curl -X PUT "$$SONARR_URL/api/qualitydefinition/$$DEF_ID" \
                     -H "Content-Type: application/json" \
                     -H "X-Api-Key: $$API_KEY" \
                     -d "{\"maxSize\": $$DEF_MAX_SIZE, \"preferredSize\": $$DEF_PREFERRED_SIZE}"
              done
          restartPolicy: OnFailure

