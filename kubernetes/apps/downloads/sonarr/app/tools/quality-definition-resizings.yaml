apiVersion: batch/v1
kind: CronJob
metadata:
  name: sonarr-quality-definitions
  namespace: downloads
spec:
  schedule: "0 1 * * *"  # Run daily at 1am
  timeZone: ${TIMEZONE}
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: sonarr-curl
            image: curlimages/curl:8.6.0@sha256:c3b8bee303c6c6beed656cfc921218c529d65aa61114eb9e27c62047a1271b9b
            command:
            - "sh"
            - "-c"
            - |
              SONARR_URL="http://sonarr.downloads.svc.cluster.local:8989" 
              API_KEY="${SONARR__API_KEY}"
              QUALITY_DEFINITIONS="7:17.4:25.4 10:17.4:25.4 11:17.4:25.4 8:23:50.4 13:23:50.4 14:23:50.4 15:23:50.4 16:23:50.4"

              # Loop over quality definitions
              for DEF in $QUALITY_DEFINITIONS; do
                DEF_ID=$(echo "$DEF" | cut -d ':' -f 1)
                DEF_PREFERRED_SIZE=$(echo "$DEF" | cut -d ':' -f 2)
                DEF_MAX_SIZE=$(echo "$DEF" | cut -d ':' -f 3)
                
                curl -X PUT "$SONARR_URL/api/v3/qualitydefinition/$DEF_ID?maxSize=$DEF_MAX_SIZE&preferredSize=$DEF_PREFERRED_SIZE" \
                     -H "Content-Type: application/json" \
                     -H "X-Api-Key: $API_KEY"
              done
          restartPolicy: OnFailure
